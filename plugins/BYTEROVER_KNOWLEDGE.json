{
  "title": "Fix duplicate critical hit animations with position-based duplicate detection",
  "description": "Fixed duplicate critical hit animations in BetterDiscord plugin by implementing position-based duplicate detection to handle DOM element replacement scenarios where messageId changes.",
  "content": "## Problem\n\nThe critical hit animation was firing **twice** for the same logical message. The animation would trigger:\n1. First when the message was sent (before crit confirmation)\n2. Second when the message was confirmed as a critical hit\n\n## Root Cause\n\nThe issue occurred because **Discord's message rendering system removes and re-adds message elements to the DOM during processing**. When a message is sent:\n\n1. Initial message element is created with a temporary/initial `messageId`\n2. Element is removed from DOM\n3. Element is re-added with a new, final `messageId` after crit confirmation\n4. The duplicate detection only checked by `messageId`, so it couldn't detect that the same logical message (same position) was being animated twice\n\n**Key observation from debug logs:**\n- First `onCritHit` call: `messageId: \"1445232539064074240\"` → added to `animatedMessages`\n- Element removed in RAF: `stillInDOM: false`, `elementChanged: true`\n- Second `onCritHit` call 11ms later: `messageId: \"1445232539420852376\"` (different ID!)\n- Position-based check couldn't find the first entry because it was deleted when element was removed\n\n## Solution\n\nImplemented **position-based duplicate detection** that runs BEFORE the atomic `messageId` check:\n\n### 1. Changed Data Structure\n\nChanged `animatedMessages` from `Set` to `Map` to store position and timestamp data:\n\n```javascript\n// Before:\nthis.animatedMessages = new Set();\n\n// After:\nthis.animatedMessages = new Map(); // Store { position, timestamp, messageId }\n```\n\n### 2. Track Element Position and Timestamp\n\nWhen `onCritHit` is called, capture element position and timestamp:\n\n```javascript\n// Get element position for duplicate detection (same position = same logical message)\nconst elementRect = messageElement.getBoundingClientRect();\nconst elementPosition = {\n  x: elementRect.left + elementRect.width / 2,\n  y: elementRect.top + elementRect.height / 2,\n};\nconst elementTimestamp = Date.now();\n```\n\n### 3. Position-Based Duplicate Detection\n\nRun position-based check BEFORE atomic check:\n\n```javascript\n// Enhanced duplicate detection: check by messageId AND by position/timing\n// This handles cases where the same logical message gets a new messageId after being removed/re-added\nconst positionTolerance = 50; // pixels\nconst timeTolerance = 2000; // ms (2 seconds - enough for message replacement)\n\n// Check if a message at the same position was recently animated\n// This includes entries that were removed (for duplicate detection when messageId changes)\nlet isDuplicateByPosition = false;\nconst currentTime = Date.now();\n\nfor (const [trackedMessageId, trackedData] of this.animatedMessages.entries()) {\n  if (trackedData && typeof trackedData === 'object' && trackedData.position) {\n    // Skip if entry is too old (beyond timeTolerance) - clean up old entries\n    const timeSinceTracked = currentTime - trackedData.timestamp;\n    if (timeSinceTracked > timeTolerance) {\n      this.animatedMessages.delete(trackedMessageId);\n      continue;\n    }\n    \n    const positionDiff =\n      Math.abs(trackedData.position.x - elementPosition.x) +\n      Math.abs(trackedData.position.y - elementPosition.y);\n    const timeDiff = elementTimestamp - trackedData.timestamp;\n    \n    // Check by position/timing (works even if trackedData.removed is true)\n    if (positionDiff < positionTolerance && timeDiff < timeTolerance) {\n      isDuplicateByPosition = true;\n      break;\n    }\n  }\n}\n\nif (isDuplicateByPosition) {\n  return; // Same logical message, skip animation\n}\n```\n\n### 4. Store Position/Timestamp with MessageId\n\nStore position and timestamp data with each messageId:\n\n```javascript\n// ATOMIC check-and-add to prevent race conditions\n// Store position and timestamp with messageId for enhanced duplicate detection\nconst sizeBefore = this.animatedMessages.size;\nconst wasAlreadyAnimated = this.animatedMessages.has(messageId);\n// Store as object with position and timestamp for enhanced duplicate detection\nthis.animatedMessages.set(messageId, {\n  position: elementPosition,\n  timestamp: elementTimestamp,\n  messageId: messageId,\n});\nconst sizeAfter = this.animatedMessages.size;\nconst isNewlyAdded = sizeAfter > sizeBefore;\n```\n\n### 5. Keep Entries When Element Removed\n\n**Critical**: Don't delete entries immediately when element is removed in RAF - keep them for the `timeTolerance` period so position-based detection can catch duplicates even when `messageId` changes.\n\n## Key Patterns & Lessons Learned\n\n### Pattern: Position-Based Duplicate Detection\nWhen DOM elements can be replaced with new IDs, track by **position/timing** instead of just ID.\n\n**When to use:**\n- DOM elements are removed and re-added with new IDs\n- Same logical entity (same position) gets different identifiers\n- Need to detect duplicates across element replacements\n\n**Implementation:**\n1. Track element position (`getBoundingClientRect()`) and timestamp\n2. Compare position differences (within tolerance) and time differences (within window)\n3. Run position check BEFORE ID-based check\n4. Keep entries for tolerance period even when elements are removed\n\n### Pattern: Run Position Check Before Atomic Check\nPosition-based detection must run **first** to catch duplicates when IDs change. If you run ID check first, you'll miss duplicates when the ID changes.\n\n### Pattern: Keep Entries for Tolerance Period\nDon't delete entries immediately when elements are removed - keep them for the duplicate detection window. Only delete after tolerance period expires.\n\n### Pattern: Clean Up Old Entries\nRemove entries after tolerance period expires to prevent memory leaks. Check age during position-based duplicate detection loop.\n\n## Code Location\n\n**File:** `betterdiscord-dev/plugins/CriticalHitAnimation.plugin.js`\n\n**Key sections:**\n- Line 28: `this.animatedMessages = new Map();`\n- Lines 211-217: Element position and timestamp tracking\n- Lines 237-271: Position-based duplicate detection\n- Lines 278-282: Storing position/timestamp with messageId\n\n## Impact\n\n- ✅ Prevents duplicate animations when message elements are replaced\n- ✅ Handles element replacement scenarios gracefully\n- ✅ Maintains smooth fade-out animation\n- ✅ Cleans up old entries automatically\n- ✅ Works even when messageId changes after element replacement",
  "tags": ["betterdiscord", "duplicate-detection", "dom-manipulation", "position-tracking", "critical-hit-animation", "bug-fix", "javascript"],
  "files": [
    "betterdiscord-dev/plugins/CriticalHitAnimation.plugin.js"
  ],
  "related": [
    "Element replacement in Discord's message rendering",
    "Race conditions in duplicate detection",
    "Memory management for tracking entries"
  ]
}
